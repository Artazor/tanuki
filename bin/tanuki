#!/usr/bin/env ruby
module Tanuki

  module Utility

    class << self

      def create(name)
        unless name
          puts "To use this command: `create <name>'"
          return
        end
        require 'fileutils'
        project_dir = File.expand_path(name)
        if File.exists? project_dir
          puts "File or directory `#{name}' already exists!"
          return
        end
        version unless @in_repl
        puts "\n creating #{name = name.downcase}"
        FileUtils.mkdir project_dir
        file_source = File.expand_path(File.join('..', '..'), __FILE__)
        puts " creating #{File.join(name, 'app')}"
        FileUtils.mkdir_p File.join(project_dir, 'app', 'user')
        FileUtils.cp_r File.join(file_source, 'app', 'user'), File.join(project_dir, 'app')
        puts " creating #{File.join(name, 'gen')}"
        FileUtils.mkdir(gen_dir = File.join(project_dir, 'gen'))
        FileUtils.chmod(0777, gen_dir)
        puts " creating #{File.join(name, 'public')}"
        FileUtils.mkdir(File.join(project_dir, 'public'))
        puts " creating #{File.join(name, 'schema')}"
        FileUtils.mkdir(File.join(project_dir, 'schema'))
        Dir.chdir(project_dir) if @in_repl
      end

      def generate(cwd)
        version unless @in_repl
        cwd = cwd ? File.expand_path(cwd) : Dir.pwd
        puts "Working directory is: #{cwd}\nTo specify another: `generate <path>'"
        require 'active_support/inflector'
        require 'yaml'
        require 'fileutils'
        require 'tanuki/extensions/object'
        require 'tanuki/behavior/meta_model_behavior'
        require 'tanuki/behavior/model_behavior'
        require 'tanuki/behavior/object_behavior'
        require 'tanuki/configurator'
        require 'tanuki/context'
        require 'tanuki/loader'
        require 'tanuki/template_compiler'
        Loader.context = ctx = Context
        default_root = File.expand_path(File.join('..', '..'), __FILE__)
        cfg = Configurator.new(Context, cwd)
        if cwd != default_root
          cfg.config_root = File.join(default_root, 'config')
          cfg.load_config :common
        end
        cfg.config_root = File.join(cwd, 'config')
        cfg.load_config :common, cwd != default_root
        puts "\n looking for models"
        @tried = {}
        @models = {}
        local_schema_root = File.expand_path(File.join('..', '..', 'schema'), __FILE__)
        generate_in(ctx)
        if ctx.schema_root != local_schema_root
          local_ctx = ctx.child
          local_ctx.schema_root = local_schema_root
          generate_in(local_ctx)
        end
        @tried.each_pair do |name, arys|
          puts "\n found: #{name}"
          arys.each_pair {|ary_name, ary| puts %{ #{ary_name}:\n - #{ary.join "\n - "}} unless ary.empty? }
        end
      end

      def generate_in(ctx)
        Dir.entries(ctx.schema_root)[2..-1].each do |namespace_path|
          namespace_name = namespace_path.split('_').map {|s| s.capitalize }.join
          namespace = @models[namespace_name] = {}
          Dir.glob(File.join(schema_root, namespace_path, 'models', '*.yml')) do |file_path|
            model_name = File.basename(file_path, '.yml').split('_').map {|s| s.capitalize }.join
            meta_model = namespace[model_name] = Tanuki_MetaModel.new(
              namespace_name,
              model_name,
              YAML.load_file(file_path),
              @models
            )
            meta_model.process!
            if @tried.include? namespace_model_name = "#{namespace_name}.#{model_name}"
              next
            else
              @tried[namespace_model_name] = {:generated => [], :failed => [], :skipped => []}
            end
          end
        end

        @models.each do |namespace_name, namespace |
          namespace.each do |model_name, meta_model|
            meta_model.process_relations!
          end
        end

        @models.each do |namespace_name, namespace |
          namespace.each do |model_name, meta_model|
            namespace_model_name = "#{namespace_name}.#{model_name}"
            {
              :model => false,
              :model_base => true,
              :manager => false,
              :manager_base => true
            }.each do |class_type, base|
              class_name = meta_model.class_name_for class_type
              path = Tanuki::Loader.class_path(class_name, base ? ctx.gen_root : ctx.app_root)
              if base || !(File.exists? path)
                begin
                  dirname = File.dirname(path)
                  FileUtils.mkdir_p dirname unless File.directory? dirname
                  File.open path, 'w' do |file|
                    writer = proc {|out| file.print out.to_s }
                    Loader.run_template({}, meta_model, class_type).call(writer, ctx)
                  end
                  @tried[namespace_model_name][:generated] << class_name unless base
                rescue
                  @tried[namespace_model_name][:failed] << class_name unless base
                end
              else
                @tried[namespace_model_name][:skipped] << class_name unless base
              end
            end
          end
        end
      end

      def execute(args)
        case args[0]
        when 'create' then create(args[1])
        when 'exit' then @in_repl ? (puts 'Bye bye!'; return false) : help
        when 'generate' then generate(args[1])
        when 'help' then help
        when 'server' then return server(args[1])
        when 'version' then version
        when nil then start_repl unless @in_repl
        else help
        end
        true
      end

      def help
        version unless @in_repl
        puts "\nbasic commands:\n"
        commands = {}
        commands['create']   = 'create a new app with the given name'
        commands['exit']     = 'exit this utility' if @in_repl
        commands['generate'] = 'generate models for application schema'
        commands['help']     = 'show help (this text)'
        commands['server']   = 'run application'
        commands['version']  = 'show framework version'
        commands.each_pair {|k, v| puts ' %-8s   %s' % [k, v] }
      end

      def init
        @in_repl = false
        execute ARGV
      end

      def server(env=nil)
        env = env ? env.to_sym : :development
        puts %{Calling for a Tanuki in "#{Dir.pwd}"}
        version unless @in_repl
        require 'tanuki'
        begin
          Application.run
          false
        rescue Interrupt
          puts 'Tanuki ran away!'
          false
        rescue SystemCallError
          puts 'Tanuki ran away! Someone else is playing here.'
          true
        end if Application.configure(env)
      end

      def start_repl
        @in_repl = true
        version
        print 'tanuki>'
        print "\ntanuki>" while gets && execute($_.chomp.scan /(?<=")\w[\w\s]*(?=")|\w+/)
      end

      def version
        begin
          require 'tanuki/version'
        rescue LoadError
          $:.unshift File.expand_path(File.join('..', '..', 'lib'), __FILE__)
          require 'tanuki/version'
        end
        puts "Tanuki version #{VERSION}"
      end

    end # end class << self

  end # end Utility

end # end Tanuki

Tanuki::Utility.init if File.basename(__FILE__) == File.basename($0)