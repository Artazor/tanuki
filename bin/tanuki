#!/usr/bin/env ruby
module Tanuki

  module Utility

    class << self

      def create(name)
        unless name
          puts "To use this command: `create <name>'"
          return
        end
        require 'fileutils'
        project_dir = File.expand_path(name)
        if File.exists? project_dir
          puts "Directory `#{name}' already exists!"
          return
        end
        version unless @in_repl
        puts "\n creating #{name = name.downcase}"
        FileUtils.mkdir project_dir
        file_source = File.expand_path(File.join('..', '..'), __FILE__)
        puts " creating #{name}/app/tanuki"
        FileUtils.mkdir_p File.join(project_dir, 'app', 'tanuki')
        FileUtils.cp_r File.join(file_source, 'app', 'tanuki'), File.join(project_dir, 'app')
        puts " creating #{name}/app/user"
        FileUtils.mkdir_p File.join(project_dir, 'app', 'user')
        FileUtils.cp_r File.join(file_source, 'app', 'user'), File.join(project_dir, 'app')
        puts " creating #{name}/cache"
        FileUtils.mkdir(File.join(project_dir, 'cache'))
        puts " creating #{name}/config"
        FileUtils.mkdir(File.join(project_dir, 'config'))
        FileUtils.cp_r File.join(file_source, 'config'), project_dir
        puts " creating #{name}/schema"
        FileUtils.mkdir(File.join(project_dir, 'schema'))
        FileUtils.cp_r File.join(file_source, 'schema'), project_dir
        puts " creating #{name}/main"
        File.open(File.join(project_dir, 'main.rb'), 'w') {|file| file.write "require 'tanuki'\nTanuki.run :development" }
      end

      def generate(cwd)
        version unless @in_repl
        unless cwd
          cwd = File.expand_path('.')
          puts "Working directory is: #{cwd}\nTo specify another: `generate <path>'"
        end
        unless File.directory? File.join(cwd, 'config')
          puts "Directory `config' not found. Are you sure there's a Tanuki here?"
          return
        end
        require 'yaml'
        require 'fileutils'
        require File.join('tanuki', 'extensions', 'object_extensions')
        require File.join('tanuki', 'configurator')
        require File.join('tanuki', 'context')
        require File.join('tanuki', 'loader')
        require File.join('tanuki', 'object_behavior')
        require File.join('tanuki', 'template_compiler')
        # TODO: move models generator here
      end

      def execute(args)
        case args[0]
        when 'create' then create(args[1])
        when 'exit' then @in_repl ? (return false) : help
        when 'generate' then generate(args[1])
        when 'help' then help
        when 'version' then version
        when nil then start_repl unless @in_repl
        else help
        end
        true
      end

      def help
        version unless @in_repl
        puts "\nbasic commands:\n"
        {
          'help'    => 'show help (this text)',
          'create'  => 'create a new app with the given name',
          'version' => 'show framework version'
        }.each_pair {|k, v| puts ' %-7s   %s' % [k, v] }
      end

      def init
        @in_repl = false
        execute ARGV
      end

      def start_repl
        @in_repl = true
        version
        print 'tanuki>'
        print "\ntanuki>" while gets && execute($_.chomp.scan /(?<=")\w[\w\s]*(?=")|\w+/)
      end

      def version
        begin
          require File.join('tanuki', 'version')
        rescue LoadError
          $:.unshift File.expand_path(File.join('..', '..', 'lib'), __FILE__)
          require File.join('tanuki', 'version')
        end
        puts "Tanuki version #{VERSION}"
      end

    end # end class << self

  end # end Utility

end # end Tanuki

Tanuki::Utility.init if File.basename(__FILE__) == File.basename($0)